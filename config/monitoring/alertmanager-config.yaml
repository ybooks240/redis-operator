apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: redis-operator-system
  labels:
    app: alertmanager
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'redis-operator@company.com'
      smtp_auth_username: 'redis-operator@company.com'
      smtp_auth_password: 'your-app-password'
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

    # 模板配置
    templates:
    - '/etc/alertmanager/templates/*.tmpl'

    # 路由配置
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'default-receiver'
      routes:
      # 关键告警立即发送
      - match:
          severity: critical
        receiver: 'critical-alerts'
        group_wait: 0s
        repeat_interval: 5m
      
      # Redis 实例相关告警
      - match_re:
          alertname: '^Redis.*'
        receiver: 'redis-alerts'
        group_by: ['alertname', 'namespace', 'name']
        group_wait: 30s
        repeat_interval: 30m
      
      # 控制器相关告警
      - match_re:
          alertname: '^RedisOperator.*'
        receiver: 'operator-alerts'
        group_by: ['alertname', 'controller']
        group_wait: 1m
        repeat_interval: 1h

    # 接收器配置
    receivers:
    - name: 'default-receiver'
      email_configs:
      - to: 'devops@company.com'
        subject: '[Redis Operator] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          {{ end }}

    - name: 'critical-alerts'
      email_configs:
      - to: 'oncall@company.com,devops@company.com'
        subject: '[CRITICAL] Redis Operator Alert: {{ .GroupLabels.alertname }}'
        body: |
          🚨 CRITICAL ALERT 🚨
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          Labels:
          {{ range .Labels.SortedPairs }}- {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
      slack_configs:
      - channel: '#redis-alerts'
        title: '🚨 Critical Redis Operator Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

    - name: 'redis-alerts'
      email_configs:
      - to: 'redis-team@company.com'
        subject: '[Redis] {{ .GroupLabels.alertname }} - {{ .GroupLabels.namespace }}/{{ .GroupLabels.name }}'
        body: |
          Redis Instance Alert
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.namespace }}/{{ .Labels.name }}
          Role: {{ .Labels.role }}
          Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
      slack_configs:
      - channel: '#redis-instances'
        title: 'Redis Instance Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Instance:* {{ .Labels.namespace }}/{{ .Labels.name }} ({{ .Labels.role }})
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

    - name: 'operator-alerts'
      email_configs:
      - to: 'platform-team@company.com'
        subject: '[Operator] {{ .GroupLabels.alertname }} - {{ .GroupLabels.controller }}'
        body: |
          Redis Operator Alert
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Controller: {{ .Labels.controller }}
          Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
      slack_configs:
      - channel: '#platform-alerts'
        title: 'Redis Operator Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Controller:* {{ .Labels.controller }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

    # 抑制规则
    inhibit_rules:
    # 如果 Redis 实例下线，抑制其他相关告警
    - source_match:
        alertname: 'RedisInstanceDown'
      target_match_re:
        alertname: '^Redis.*'
      equal: ['namespace', 'name']
    
    # 如果控制器下线，抑制所有控制器相关告警
    - source_match:
        alertname: 'RedisOperatorControllerDown'
      target_match_re:
        alertname: '^RedisOperator.*'
      equal: ['controller']

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: redis-operator-system
  labels:
    app: alertmanager
data:
  default.tmpl: |
    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
    
    {{ define "__description" }}{{ end }}
    
    {{ define "__text_alert_list" }}{{ range . }}Labels:
    {{ range .Labels.SortedPairs }}- {{ .Name }} = {{ .Value }}
    {{ end }}Annotations:
    {{ range .Annotations.SortedPairs }}- {{ .Name }} = {{ .Value }}
    {{ end }}Source: {{ .GeneratorURL }}
    {{ end }}{{ end }}
    
    {{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "slack.default.text" }}{{ if gt (len .Alerts.Firing) 0 }}**Firing:**
    {{ template "__text_alert_list" .Alerts.Firing }}{{ end }}{{ if gt (len .Alerts.Resolved) 0 }}**Resolved:**
    {{ template "__text_alert_list" .Alerts.Resolved }}{{ end }}{{ end }}
    
    {{ define "email.default.subject" }}{{ template "__subject" . }}{{ end }}
    {{ define "email.default.html" }}
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>{{ template "__subject" . }}</title>
    <style>
    /* Global styles */
    body { margin: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; width: 100% !important; height: 100%; line-height: 1.6em; background-color: #f6f6f6; }
    table { background-color: #f6f6f6; }
    .body-wrap { background-color: #f6f6f6; width: 100%; }
    .container { display: block !important; max-width: 600px !important; margin: 0 auto !important; clear: both !important; }
    .content { max-width: 600px; margin: 0 auto; display: block; padding: 20px; }
    .main { background-color: #fff; border: 1px solid #e9e9e9; border-radius: 3px; }
    .content-wrap { padding: 20px; }
    .content-block { padding: 0 0 20px; }
    .header { width: 100%; margin-bottom: 20px; }
    .footer { width: 100%; clear: both; color: #999; padding: 20px; }
    h1, h2, h3 { font-family: 'Helvetica Neue', Helvetica, Arial, 'Lucida Grande', sans-serif; color: #000; margin: 40px 0 0; line-height: 1.2em; font-weight: 400; }
    h1 { font-size: 32px; font-weight: 500; }
    h2 { font-size: 24px; }
    h3 { font-size: 18px; }
    p, ul, ol { margin-bottom: 10px; font-weight: normal; }
    p li, ul li, ol li { margin-left: 5px; list-style-position: inside; }
    .btn { text-decoration: none; color: #FFF; background-color: #348eda; border: solid #348eda; border-width: 10px 20px; line-height: 2em; font-weight: bold; text-align: center; cursor: pointer; display: inline-block; border-radius: 5px; text-transform: capitalize; }
    .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }
    .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    </style>
    </head>
    <body>
    <table class="body-wrap">
        <tr>
            <td></td>
            <td class="container" width="600">
                <div class="content">
                    <table class="main" width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                            <td class="content-wrap">
                                <table width="100%" cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td class="content-block">
                                            <h2>Redis Operator Alert</h2>
                                        </td>
                                    </tr>
                                    {{ if gt (len .Alerts.Firing) 0 }}
                                    <tr>
                                        <td class="content-block">
                                            <div class="alert alert-danger">
                                                <strong>Firing Alerts ({{ .Alerts.Firing | len }})</strong>
                                            </div>
                                        </td>
                                    </tr>
                                    {{ range .Alerts.Firing }}
                                    <tr>
                                        <td class="content-block">
                                            <h3>{{ .Annotations.summary }}</h3>
                                            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
                                            <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
                                            <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
                                            <p><strong>Labels:</strong></p>
                                            <ul>
                                            {{ range .Labels.SortedPairs }}
                                                <li>{{ .Name }}: {{ .Value }}</li>
                                            {{ end }}
                                            </ul>
                                        </td>
                                    </tr>
                                    {{ end }}
                                    {{ end }}
                                    
                                    {{ if gt (len .Alerts.Resolved) 0 }}
                                    <tr>
                                        <td class="content-block">
                                            <div class="alert alert-success">
                                                <strong>Resolved Alerts ({{ .Alerts.Resolved | len }})</strong>
                                            </div>
                                        </td>
                                    </tr>
                                    {{ range .Alerts.Resolved }}
                                    <tr>
                                        <td class="content-block">
                                            <h3>{{ .Annotations.summary }}</h3>
                                            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
                                            <p><strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05" }}</p>
                                        </td>
                                    </tr>
                                    {{ end }}
                                    {{ end }}
                                </table>
                            </td>
                        </tr>
                    </table>
                    <div class="footer">
                        <table width="100%">
                            <tr>
                                <td class="content-block">
                                    <span class="apple-link">Redis Operator Monitoring System</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </td>
            <td></td>
        </tr>
    </table>
    </body>
    </html>
    {{ end }}